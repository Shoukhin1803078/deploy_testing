<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUROCO LAB chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="static/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div>
                <h2>KUROCOLAB Bot</h2>
                <ul>
                    <li><a href="#"><i class="fas fa-home"></i> <span class="menu-text" data-en="Home" data-jp="ホーム">Home</span></a></li>
                    <li><a href="#"><i class="fas fa-project-diagram"></i> <span class="menu-text" data-en="Projects" data-jp="プロジェクト">Projects</span></a></li>
                    <li><a href="#"><i class="fas fa-file-alt"></i> <span class="menu-text" data-en="Documents" data-jp="ドキュメント">Documents</span></a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> <span class="menu-text" data-en="Settings" data-jp="設定">Settings</span></a></li>
                </ul>
            </div>
            <div class="sidebar-buttons">
                <button id="clear-chat"><i class="fas fa-trash"></i> <span class="button-text" data-en="Clear Chat" data-jp="チャットをクリア">Clear Chat</span></button>
                <button id="export-chat"><i class="fas fa-download"></i> <span class="button-text" data-en="Export Chat" data-jp="チャットをエクスポート">Export Chat</span></button>
            </div>
            <div id="language-selection">
                <h3 class="menu-text" data-en="Language" data-jp="言語">Language</h3>
                <div class="language-option active" onclick="setLanguage('en')">
                    <img src="https://flagcdn.com/w40/gb.png" alt="English">
                    <span class="language-label">English</span>
                </div>
                <div class="language-option" onclick="setLanguage('jp')">
                    <img src="https://flagcdn.com/w40/jp.png" alt="日本語">
                    <span class="language-label">日本語</span>
                </div>
            </div>
            <div class="copyright">
                <h4>Ⓒ2024 FREECOMPANY Inc.</h4>
            </div>
        </div>
        <div class="main-content">
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="typing-indicator" style="display: none;">
                    <div class="loading-animation">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>
            <div id="user-input-container">
                <textarea id="user-input" placeholder="Type your message here..." data-en="Type your message here..." data-jp="メッセージを入力してください..."></textarea>
                <button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython_stdlib.js"></script>

    <script type="text/python">
        from browser import document, ajax, window
        import json

        user_language = 'en'

        def on_complete(req):
            response = json.loads(req.text)
            add_message(response['response'], 'bot')
            hide_typing_indicator()

        def send_message(event):
            user_input = document['user-input'].value
            if user_input.strip() == "":
                return
            add_message(user_input, 'user')
            document['user-input'].value = ""
            show_typing_indicator()
            
            req = ajax.Ajax()
            req.bind('complete', on_complete)
            req.open('POST', '/chat', True)
            req.set_header('content-type', 'application/json')
            req.send(json.dumps({'message': user_input, 'language': user_language}))

        def add_message(message, sender):
            chat_messages = document['chat-messages']
            new_message = document.createElement('div')
            new_message.classList.add('message', f'{sender}-message')
            if sender == 'bot':
                # Parse Markdown for bot messages
                new_message.innerHTML = window.marked(message)
            else:
                new_message.textContent = message
            chat_messages.insertBefore(new_message, chat_messages.firstChild)
            chat_messages.scrollTop = 0

        def show_typing_indicator():
            typing_indicator = document['typing-indicator']
            typing_indicator.style.display = 'block'
            window.setTimeout(lambda: typing_indicator.classList.add('visible'), 10)

        def hide_typing_indicator():
            typing_indicator = document['typing-indicator']
            typing_indicator.classList.remove('visible')
            window.setTimeout(lambda: setattr(typing_indicator.style, 'display', 'none'), 300)

        def clear_chat(event):
            document['chat-messages'].innerHTML = ''

        def export_chat(event):
            chat_content = document['chat-messages'].innerHTML
            
            req = ajax.Ajax()
            req.bind('complete', on_export_complete)
            req.open('POST', '/export-chat', True)
            req.set_header('content-type', 'application/json')
            req.send(json.dumps({'content': chat_content}))

        def on_export_complete(req):
            if req.status == 200:
                blob = window.Blob.new([req.text], {'type': 'text/html'})
                url = window.URL.createObjectURL(blob)
                a = document.createElement('a')
                a.href = url
                a.download = 'chat_export.html'
                a.click()
                window.URL.revokeObjectURL(url)
                
                content_size = len(req.text) / 1024  # size in KB
                window.alert(f"Chat exported successfully. Size: {content_size:.2f} KB")
            else:
                error_message = json.loads(req.text)['error']
                window.alert(f"Export failed: {error_message}")

        def set_language(lang):
            global user_language
            user_language = lang
            if lang == 'en':
                initial_message = "Hello! I'm the KUROCOLAB chatbot, your managing director for project implementation. How can I assist you today?"
                document.select_one('.language-option:nth-of-type(1)').classList.add('active')
                document.select_one('.language-option:nth-of-type(2)').classList.remove('active')
            else:
                initial_message = "こんにちは！KUROCOLABチャットボットです。プロジェクト実施のマネージングディレクターとして、本日はどのようなお手伝いができますか？"
                document.select_one('.language-option:nth-of-type(2)').classList.add('active')
                document.select_one('.language-option:nth-of-type(1)').classList.remove('active')
            document['chat-messages'].innerHTML = ''
            add_message(initial_message, 'bot')
            update_ui_text(lang)

        def update_ui_text(lang):
            elements = document.select('.menu-text, .button-text')
            for el in elements:
                el.text = el.attrs[f'data-{lang}']
            document['user-input'].attrs['placeholder'] = document['user-input'].attrs[f'data-{lang}']

        document['send-button'].bind('click', send_message)
        document['user-input'].bind('keypress', lambda event: send_message(event) if event.keyCode == 13 and not event.shiftKey else None)
        document['clear-chat'].bind('click', clear_chat)
        document['export-chat'].bind('click', export_chat)

        window.setLanguage = set_language

        # Initial bot message
        set_language('en')
    </script>

    <script type="text/javascript">
        window.onload = function() {
            brython();
        }
    </script>
</body>
</html>